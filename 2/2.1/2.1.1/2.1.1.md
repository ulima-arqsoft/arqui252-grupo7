# 2.1.1. Módulo 1 – Gestión de Compras – Kohji Onaja

El módulo de **Gestión de Compras** permite a los usuarios realizar el proceso completo de adquisición de productos dentro del ecosistema de Ecommerce de Ropa.  
Abarca desde la administración del carrito, selección de dirección y método de pago, hasta la confirmación y registro de la transacción.  
Busca ofrecer una **experiencia de compra fluida, segura y confiable** en las aplicaciones móviles Android/iOS y la plataforma web.

---

## Alcance
Facilitar al cliente la compra de productos desde el catálogo, permitiéndole:
- Agregar y modificar productos en su carrito.  
- Revisar precios, costos de envío y totales.  
- Seleccionar dirección de entrega y método de pago.  
- Confirmar la compra y recibir notificación del pedido.  
- Consultar historial de compras y estados de pedido.  

El módulo se integra con:
- **Catálogo de Productos:** para verificar precios y disponibilidad.  
- **Gestión de Usuarios:** para recuperar direcciones e identidad del comprador.  
- **Pasarela de Pagos:** para procesar transacciones seguras.  
- **Gestión de Pedidos:** para almacenar, actualizar y notificar el estado del pedido.

---

## Supuestos
- El backend está implementado en **Node.js con PostgreSQL**.  
- La integración con pasarela de pagos se realiza vía **API REST** con autenticación OAuth2.  
- El flujo de pedidos está sincronizado en tiempo real con el módulo de **Inventario y Pedidos**.  
- Los pagos se procesan en moneda local (PEN).  
- La sesión del usuario está autenticada mediante JWT.

---

## Requisitos Funcionales

### RF-GC-01 Carrito de Compras
El usuario puede agregar, eliminar y modificar productos dentro de su carrito antes de finalizar la compra.  
- **Aceptación:** al agregar un producto, se refleja en el carrito con cantidad y subtotal actualizados.

---

### RF-GC-02 Cálculo de Totales
El sistema calcula automáticamente el subtotal, impuestos, envío y total general del pedido.  
- **Aceptación:** el total se actualiza en tiempo real al modificar cantidades o eliminar productos.

---

### RF-GC-03 Selección de Dirección
El usuario selecciona una dirección guardada o registra una nueva antes del pago.  
- **Aceptación:** la dirección elegida se asocia correctamente al pedido confirmado.

---

### RF-GC-04 Selección de Método de Pago
El usuario elige entre los métodos disponibles (tarjeta, billetera digital, transferencia).  
- **Aceptación:** el sistema valida el método y prepara la transacción con la pasarela configurada.

---

### RF-GC-05 Confirmación del Pedido
Al confirmar, el sistema registra el pedido y genera un número único de orden.  
- **Aceptación:** el usuario recibe una notificación visual (“Compra confirmada”) y un correo con el detalle.

---

### RF-GC-06 Procesamiento de Pago
Se realiza la transacción con la pasarela externa y se recibe la respuesta de autorización o rechazo.  
- **Aceptación:** en caso de éxito, el pedido se marca como “Pagado”; en caso de error, se muestra mensaje claro y opción de reintento.

---

### RF-GC-07 Actualización del Estado del Pedido
El estado pasa por las etapas: *Pendiente → Pagado → En preparación → Enviado → Entregado*.  
- **Aceptación:** el usuario puede consultar el estado en su historial y recibe notificaciones automáticas de cambio.

---

### RF-GC-08 Notificaciones y Confirmaciones
El sistema envía notificaciones push o correo electrónico después de la compra o en cada cambio de estado.  
- **Aceptación:** cada notificación se registra en logs con timestamp y estado de envío.

---

### RF-GC-09 Historial de Compras
El usuario puede consultar sus pedidos previos con detalles (fecha, monto, productos, estado).  
- **Aceptación:** se muestran los últimos 12 pedidos y opción para cargar más.

---

### RF-GC-10 Cancelaciones y Devoluciones
El usuario puede solicitar cancelación antes del envío o devolución dentro del plazo permitido.  
- **Aceptación:** el sistema registra la solicitud, actualiza el estado del pedido y genera un ticket para atención.

---

### RF-GC-11 Auditoría y Registro
Todos los eventos (creación de pedido, pago, cambio de estado) se registran con trazabilidad completa.  
- **Aceptación:** cada registro incluye `order_id`, `user_id`, `timestamp`, `status` y `source`.

---

## Requisitos de Atributos de Calidad

| Atributo de Calidad | Estímulo | Fuente del Estímulo | Artefacto | Entorno | Respuesta | Medida de Respuesta |
|----------------------|----------|----------------------|------------|---------|-----------|----------------------|
| Rendimiento | Un usuario confirma una compra en hora pico | Cliente | Backend de compras | Operación normal | El sistema procesa la transacción completa sin demoras perceptibles | Tiempo de respuesta < 3 s |
| Disponibilidad | Alta demanda simultánea (Black Friday) | Múltiples usuarios | API de compras y pasarela de pago | Producción | El sistema mantiene funcionamiento estable sin caídas | Uptime ≥ 99.9% mensual |
| Seguridad | Usuario intenta manipular el monto en el cliente | Usuario malintencionado | API de pagos | Producción | El sistema valida montos y rechaza inconsistencias | 100% de transacciones fraudulentas detectadas |
| Fiabilidad | Se repite el envío de una misma transacción por error | Pasarela externa | Backend de compras | Producción | El sistema evita duplicar registros (idempotencia) | 0 compras duplicadas |
| Usabilidad | Usuario nuevo completa una compra por primera vez | Cliente | App móvil | Normal | El flujo de compra resulta claro, guiado y finalizable sin ayuda | Tasa de finalización ≥ 90% |
| Mantenibilidad | Se agrega un nuevo método de pago (billetera digital) | Equipo de desarrollo | Módulo de pagos | Desarrollo | La nueva integración se agrega sin afectar funcionalidades existentes | Tiempo de despliegue < 4 h |

---

## Restricciones
- El módulo de **Gestión de Compras** deberá integrarse con la **pasarela de pagos seleccionada (Izipay o Culqui)** mediante API REST segura.  
- Solo se permiten compras en moneda **PEN** en esta primera versión.  
- El flujo de confirmación debe funcionar con **autenticación obligatoria (JWT)**.  
- La base de datos de pedidos y transacciones residirá en **PostgreSQL**.  
- El backend compartirá infraestructura con otros módulos, sin autoescalado dinámico inicial.  
- Se deberán cumplir las **normas de protección de datos personales (GDPR / Ley local)**.  
- La interfaz debe seguir las **guías de diseño UX/UI del proyecto** y estar alineada con el flujo del carrito y catálogo.
